---
export interface Props {
  color?: string;
  height?: string;
  size?: string;
  thickness?: string;
  class?: string;
  animationDuration?: number;
  threshold?: number | false;
}

const {
  color = '#0969da',
  height,
  size,
  thickness,
  class: className = 'astro-loading-spinner',
  animationDuration = 300,
  threshold: defaultThreshold = 200,
} = Astro.props;

const spinnerSize = size ?? height ?? '32px';
const spinnerThickness = thickness ?? '3px';
const threshold = defaultThreshold;
const spinDuration = Math.max(600, animationDuration * 4);

const keyframesName = 'astro-loading-spinner-spin';
const styles = `.${className} {
  pointer-events: none;
  color: ${color};
  position: fixed;
  inset: 0;
  z-index: 1031;
  display: grid;
  place-items: center;
  opacity: 0;
  transition: opacity ${animationDuration}ms ease-out;
}

.${className}[data-active="true"] {
  opacity: 1;
}

.${className}::before {
  content: "";
  width: ${spinnerSize};
  height: ${spinnerSize};
  border-radius: 999px;
  border: ${spinnerThickness} solid currentColor;
  border-right-color: transparent;
  border-top-color: transparent;
  box-sizing: border-box;
  animation: ${keyframesName} ${spinDuration}ms linear infinite;
}

@keyframes ${keyframesName} {
  to {
    transform: rotate(360deg);
  }
}
`;
---

<style set:html={styles}></style>

<script is:inline define:vars={{ className, threshold }}>
(() => {
  if (window.__astroLoadingSpinner) {
    return
  }
  window.__astroLoadingSpinner = true

  let thresholdTimeout = undefined
  let isActive = false

  const element = document.createElement("div")
  element.classList.add(className)
  element.setAttribute("aria-hidden", "true")

  const setActive = (value) => {
    isActive = value
    if (value) {
      element.setAttribute("data-active", "true")
      return
    }
    element.removeAttribute("data-active")
  }

  const mount = (doc) => {
    if (!doc.body) {
      return
    }
    doc.body.prepend(element)
  }

  setActive(false)

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => mount(document))
  } else {
    mount(document)
  }

  const startSpinner = () => {
    if (isActive) {
      return
    }
    setActive(true)
  }

  document.addEventListener("astro:before-preparation", () => {
    if (threshold === false || threshold <= 0) {
      startSpinner()
      return
    }

    thresholdTimeout = window.setTimeout(() => {
      thresholdTimeout = undefined
      startSpinner()
    }, threshold)
  })

  document.addEventListener("astro:before-swap", (event) => {
    if (thresholdTimeout !== undefined) {
      window.clearTimeout(thresholdTimeout)
      thresholdTimeout = undefined
    }

    if (!isActive) {
      return
    }

    mount(event.newDocument)

    setActive(false)
  })
})()
</script>
